{% extends "template.html" %}
{% block content %}

<style>
  #map {
    height: 100vh;
    width: 100%;
  }
</style>

<div id="map"></div>

<script>
  const constants = {
    MAP: {
      DOM_ELEMENT_ID: 'map',
      RIO_GRANDE_CITY_GEOCENTER_COORDINATES: [-32.0453936, -52.1160472],
      BASE_ZOOM_LEVEL: 12.7,
    },
    TILE_LAYER: {
      TILE_URL: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
      OPTIONS: {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      },
    },
    ICONS: {
      SHADOR_URL: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      SIZE: [25, 41],
      ANCHOR: [12, 41],
      ANCHOR_POPUP: [1, -34],
      SHADOW_SIZE: [41, 41],
    },
  };

  const map = L.map(constants.MAP.DOM_ELEMENT_ID).setView(constants.MAP.RIO_GRANDE_CITY_GEOCENTER_COORDINATES, constants.MAP.BASE_ZOOM_LEVEL);

  L.tileLayer(constants.TILE_LAYER.TILE_URL, constants.TILE_LAYER.OPTIONS).addTo(map);

  function getIcon(color) {
    return new L.Icon({
      iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
      shadowUrl: constants.ICONS.SHADOR_URL,
      iconSize: constants.ICONS.SIZE,
      iconAnchor: constants.ICONS.ANCHOR,
      popupAnchor: constants.ICONS.ANCHOR_POPUP,
      shadowSize: constants.ICONS.SHADOW_SIZE,
    });
  }

  const blueIcon = getIcon('blue');
  const goldIcon = getIcon('gold');
  const redIcon = getIcon('red');

  function addMarker(lat, lng, popupContent, icon = blueIcon) {
    const marker = L.marker([lat, lng], { icon: icon }).addTo(map);
    marker.bindPopup(popupContent).openPopup();
  }

  function addPolygon(coordinates, popupContent) {
    const coords = coordinates.map((coord) => [coord[1], coord[0]]);

    const polygon = L.polygon(coords).addTo(map);
    polygon.setStyle({ fillColor: 'red' });
    polygon.bindPopup(popupContent).openPopup();
  }

  {% for marker in markers["Marcadores"] %}
  addMarker({{ marker.lat }}, {{ marker.lng }}, "<b>{{ marker.tipo }}</b><br> {{ marker.necessidades | safe }}<b>{{ marker.nome }}</b><br> {{ marker.endereco }} <br> <b>{{ marker.horario }}</b>", {{ marker.icon }});
  {% endfor %}

  const poly = L.geoJSON({{ riskareas | safe }}, {
    style: function (feature) {
      return { color: feature.properties.fill, weight: 1.2 };
    }
  }).bindPopup(function (layer) {
    return layer.feature.properties.desc;
  }).addTo(map);
</script>
{% endblock %}
